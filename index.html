<!DOCTYPE html><html lang="en" dir="ltr"><head>
<meta charset="utf-8">
<meta name="generator" content="ReSpec 35.1.2">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;background:var(--indextable-hover-bg,#fff);color:#000;color:var(--text,#000);box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);box-shadow:0 1em 3em -.4em var(--tocsidebar-shadow,rgba(0,0,0,.3)),0 0 1px 1px var(--tocsidebar-shadow,rgba(0,0,0,.05));border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;border-bottom-color:var(--indextable-hover-bg,#fff);top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1;border-bottom-color:var(--indextable-hover-bg,#a2a9b1)}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;color:var(--text,#000);margin-top:.25em}
.dfn-panel ul a[href]{color:#333;color:var(--text,#333)}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
		
		
<title>Spec Prod Documentation</title>
		
		
	
<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline}
:is(h2,h3,h4,h5,h6):not(#toc>h2,#abstract>h2,#sotd>h2,.head>h2){position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-1.1em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"ยง";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}
</style>
<meta name="color-scheme" content="light">
<meta name="description" content="The w3c/spec-prod GitHub Action lets you:">
<style>
.hljs{--base:#fafafa;--mono-1:#383a42;--mono-2:#686b77;--mono-3:#717277;--hue-1:#0b76c5;--hue-2:#336ae3;--hue-3:#a626a4;--hue-4:#42803c;--hue-5:#ca4706;--hue-5-2:#c91243;--hue-6:#986801;--hue-6-2:#9a6a01}
@media (prefers-color-scheme:dark){
.hljs{--base:#282c34;--mono-1:#abb2bf;--mono-2:#818896;--mono-3:#5c6370;--hue-1:#56b6c2;--hue-2:#61aeee;--hue-3:#c678dd;--hue-4:#98c379;--hue-5:#e06c75;--hue-5-2:#be5046;--hue-6:#d19a66;--hue-6-2:#e6c07b}
}
.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;color:var(--mono-1,#383a42);background:#fafafa;background:var(--base,#fafafa)}
.hljs-comment,.hljs-quote{color:#717277;color:var(--mono-3,#717277);font-style:italic}
.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4;color:var(--hue-3,#a626a4)}
.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#ca4706;color:var(--hue-5,#ca4706);font-weight:700}
.hljs-literal{color:#0b76c5;color:var(--hue-1,#0b76c5)}
.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#42803c;color:var(--hue-4,#42803c)}
.hljs-built_in,.hljs-class .hljs-title{color:#9a6a01;color:var(--hue-6-2,#9a6a01)}
.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801;color:var(--hue-6,#986801)}
.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#336ae3;color:var(--hue-2,#336ae3)}
.hljs-emphasis{font-style:italic}
.hljs-strong{font-weight:700}
.hljs-link{text-decoration:underline}
</style>
<style>
var{position:relative;cursor:pointer}
var[data-type]::after,var[data-type]::before{position:absolute;left:50%;top:-6px;opacity:0;transition:opacity .4s;pointer-events:none}
var[data-type]::before{content:"";transform:translateX(-50%);border-width:4px 6px 0 6px;border-style:solid;border-color:transparent;border-top-color:#222}
var[data-type]::after{content:attr(data-type);transform:translateX(-50%) translateY(-100%);background:#222;text-align:center;font-family:"Dank Mono","Fira Code",monospace;font-style:normal;padding:6px;border-radius:3px;color:#daca88;text-indent:0;font-weight:400}
var[data-type]:hover::after,var[data-type]:hover::before{opacity:1}
</style>
<script id="initialUserConfig" type="application/json">{
  "specStatus": "base",
  "editors": [
    {
      "name": "Sid Vishnoi",
      "url": "https://github.com/sidvishnoi"
    }
  ],
  "github": {
    "repoURL": "https://github.com/w3c/spec-prod",
    "branch": "main"
  },
  "tocIntroductory": true,
  "postProcess": [
    null,
    null,
    null,
    null
  ],
  "publishISODate": "2024-11-22T00:00:00.000Z",
  "generatedSubtitle": "22 November 2024"
}</script>
<link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/2021/base.css"></head>
	<body class="h-entry informative toc-inline"><div class="head">
    
    <h1 id="title" class="title">Spec Prod Documentation</h1> 
    <p id="w3c-state"> <time class="dt-published" datetime="2024-11-22">22 November 2024</time></p>
    <details open="">
      <summary>More details about this document</summary>
      <dl>
        
        
        <dt>Latest editor's draft:</dt><dd><a href="https://w3c.github.io/spec-prod/">https://w3c.github.io/spec-prod/</a></dd>
        
        
        
        
        
        
        <dt>Editor:</dt><dd class="editor p-author h-card vcard">
    <a class="u-url url p-name fn" href="https://github.com/sidvishnoi">Sid Vishnoi</a>
  </dd>
        
        
        <dt>Feedback:</dt><dd>
        <a href="https://github.com/w3c/spec-prod/">GitHub w3c/spec-prod</a>
        (<a href="https://github.com/w3c/spec-prod/pulls/">pull requests</a>,
        <a href="https://github.com/w3c/spec-prod/issues/new/choose">new issue</a>,
        <a href="https://github.com/w3c/spec-prod/issues/">open issues</a>)
      </dd>
        
        
      </dl>
    </details>
    
    
    
    <hr title="Separator for header">
  </div>
		
		<section id="abstract" class="introductory"><h2>Abstract</h2>
			<p>The w3c/spec-prod GitHub Action lets you:</p>
			<ul>
				<li>
					Build <a href="https://github.com/w3c/respec">ReSpec</a> and
					<a href="https://github.com/tabatkins/bikeshed">Bikeshed</a>
					specs.
				</li>
				<li>
					Validate input/generated document's markup and check for broken
					hyperlinks.
				</li>
				<li>
					Publish generated spec to GitHub Pages and/or w3.org (using Echidna).
				</li>
			</ul>
		</section><nav id="toc"><h2 class="introductory" id="table-of-contents">Table of Contents</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Abstract</a></li><li class="tocline"><a class="tocxref" href="#getting-started"><bdi class="secno">1. </bdi>Getting started</a></li><li class="tocline"><a class="tocxref" href="#examples"><bdi class="secno">2. </bdi>Examples</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#run-as-a-validator-on-pull-requests"><bdi class="secno">2.1 </bdi>Run as a validator on pull requests</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#selectively-enable-disable-validators"><bdi class="secno">2.1.1 </bdi>Selectively enable/disable validators</a></li></ol></li><li class="tocline"><a class="tocxref" href="#specify-toolchain-bikeshed-or-respec"><bdi class="secno">2.2 </bdi>Specify toolchain: Bikeshed or ReSpec</a></li><li class="tocline"><a class="tocxref" href="#deploy-to-github-pages"><bdi class="secno">2.3 </bdi>Deploy to GitHub pages</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#change-output-location-for-built-files"><bdi class="secno">2.3.1 </bdi>Change output location for built files</a></li></ol></li><li class="tocline"><a class="tocxref" href="#deploy-to-w3c-using-echidna"><bdi class="secno">2.4 </bdi>Deploy to W3C using Echidna</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#use-different-respecconfig-when-deploying-to-w3c"><bdi class="secno">2.4.1 </bdi>Use different <code>respecConfig</code> when deploying to W3C</a></li></ol></li><li class="tocline"><a class="tocxref" href="#multiple-specs-in-same-repository"><bdi class="secno">2.5 </bdi>Multiple specs in same repository</a></li></ol></li><li class="tocline"><a class="tocxref" href="#options"><bdi class="secno">3. </bdi>Options</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#toolchain"><bdi class="secno">3.1 </bdi><code>TOOLCHAIN</code></a></li><li class="tocline"><a class="tocxref" href="#source"><bdi class="secno">3.2 </bdi><code>SOURCE</code></a></li><li class="tocline"><a class="tocxref" href="#destination"><bdi class="secno">3.3 </bdi><code>DESTINATION</code></a></li><li class="tocline"><a class="tocxref" href="#build_fail_on"><bdi class="secno">3.4 </bdi><code>BUILD_FAIL_ON</code></a></li><li class="tocline"><a class="tocxref" href="#gh_pages_build_override"><bdi class="secno">3.5 </bdi><code>GH_PAGES_BUILD_OVERRIDE</code></a></li><li class="tocline"><a class="tocxref" href="#w3c_build_override"><bdi class="secno">3.6 </bdi><code>W3C_BUILD_OVERRIDE</code></a></li><li class="tocline"><a class="tocxref" href="#validate_input_markup"><bdi class="secno">3.7 </bdi><code>VALIDATE_INPUT_MARKUP</code></a></li><li class="tocline"><a class="tocxref" href="#validate_webidl"><bdi class="secno">3.8 </bdi><code>VALIDATE_WEBIDL</code></a></li><li class="tocline"><a class="tocxref" href="#validate_links"><bdi class="secno">3.9 </bdi><code>VALIDATE_LINKS</code></a></li><li class="tocline"><a class="tocxref" href="#validate_markup"><bdi class="secno">3.10 </bdi><code>VALIDATE_MARKUP</code></a></li><li class="tocline"><a class="tocxref" href="#gh_pages_branch"><bdi class="secno">3.11 </bdi><code>GH_PAGES_BRANCH</code></a></li><li class="tocline"><a class="tocxref" href="#gh_pages_token"><bdi class="secno">3.12 </bdi><code>GH_PAGES_TOKEN</code></a></li><li class="tocline"><a class="tocxref" href="#w3c_echidna_token"><bdi class="secno">3.13 </bdi><code>W3C_ECHIDNA_TOKEN</code></a></li><li class="tocline"><a class="tocxref" href="#w3c_wg_decision_url"><bdi class="secno">3.14 </bdi><code>W3C_WG_DECISION_URL</code></a></li><li class="tocline"><a class="tocxref" href="#w3c_notifications_cc"><bdi class="secno">3.15 </bdi><code>W3C_NOTIFICATIONS_CC</code></a></li><li class="tocline"><a class="tocxref" href="#artifact_name"><bdi class="secno">3.16 </bdi><code>ARTIFACT_NAME</code></a></li></ol></li><li class="tocline"><a class="tocxref" href="#other-useful-resources"><bdi class="secno">4. </bdi>Other useful resources</a></li></ol></nav>
		<section id="getting-started"><div class="header-wrapper"><h2 id="x1-getting-started"><bdi class="secno">1. </bdi>Getting started</h2><a class="self-link" href="#getting-started" aria-label="Permalink for Section 1."></a></div>
<p>To get started, do the following:</p>
<ol>
<li><p>If you want to deploy to W3C /TR:</p>
<ol>
<li><a href="https://www.w3.org/Web/publications/register">Request an Echidna token</a> for your spec (W3C Team Members and Chairs only!).</li>
<li><a href="https://docs.github.com/en/actions/reference/encrypted-secrets#creating-encrypted-secrets-for-a-repository">Save the token</a> as a "Secret" named <code>ECHIDNA_TOKEN</code> in the spec's repository's settings.</li>
</ol>
</li>
<li><p>Create a <code>.github/workflows/auto-publish.yml</code> file at the root of the spec's repository.</p>
</li>
<li><p>In the <code>auto-publish.yml</code>, copy-paste and modify one of the <a href="#examples">examples</a> below that suits your needs. Most typical one:</p>
<pre class="example"><code class="yml hljs" aria-busy="false"># Inside .github/workflows/auto-publish.yml
name: Automatic Publication

on:
  pull_request: {}
  push:
    branches: [main]

jobs:
  validate-and-publish:
    name: Validate and Publish to TR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          TOOLCHAIN: respec # or bikeshed
          W3C_ECHIDNA_TOKEN: ${{ secrets.ECHIDNA_TOKEN }}
          W3C_WG_DECISION_URL: " See Options for URLs! "
          # Convert Editor's Draft to Working Draft!
          W3C_BUILD_OVERRIDE: |
            specStatus: WD
</code></pre>
</li>
</ol>
</section>
		<section id="examples"><div class="header-wrapper"><h2 id="x2-examples"><bdi class="secno">2. </bdi>Examples</h2><a class="self-link" href="#examples" aria-label="Permalink for Section 2."></a></div>
<section id="run-as-a-validator-on-pull-requests"><div class="header-wrapper"><h3 id="x2-1-run-as-a-validator-on-pull-requests"><bdi class="secno">2.1 </bdi>Run as a validator on pull requests</h3><a class="self-link" href="#run-as-a-validator-on-pull-requests" aria-label="Permalink for Section 2.1"></a></div>
<p>If you do not pass any inputs, it by default builds a ReSpec or Bikeshed document (<code>index.html</code> or <code>index.bs</code>) and validates the output. It does not deploy the built document anywhere.</p>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Create a file called .github/workflows/auto-publish.yml
name: CI
on:
  pull_request: {}
jobs:
  main:
    name: Build and Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
</code></pre>
<section id="selectively-enable-disable-validators"><div class="header-wrapper"><h4 id="x2-1-1-selectively-enable-disable-validators"><bdi class="secno">2.1.1 </bdi>Selectively enable/disable validators</h4><a class="self-link" href="#selectively-enable-disable-validators" aria-label="Permalink for Section 2.1.1"></a></div>
<p>By default, both markup and Web IDL validators are enabled.</p>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Create a file called .github/workflows/auto-publish.yml
name: CI
on:
  pull_request: {}
jobs:
  main:
    name: Build and Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          VALIDATE_WEBIDL: false
          VALIDATE_MARKUP: true
</code></pre>
</section></section><section id="specify-toolchain-bikeshed-or-respec"><div class="header-wrapper"><h3 id="x2-2-specify-toolchain-bikeshed-or-respec"><bdi class="secno">2.2 </bdi>Specify toolchain: Bikeshed or ReSpec</h3><a class="self-link" href="#specify-toolchain-bikeshed-or-respec" aria-label="Permalink for Section 2.2"></a></div>
<p>Specify <code>TOOLCHAIN</code> if the action cannot figure out the toolchain itself, or if you like to be explicit.</p>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Create a file called .github/workflows/auto-publish.yml
name: CI
on:
  pull_request: {}
jobs:
  main:
    name: Build and Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          TOOLCHAIN: respec # or bikeshed
</code></pre>
</section><section id="deploy-to-github-pages"><div class="header-wrapper"><h3 id="x2-3-deploy-to-github-pages"><bdi class="secno">2.3 </bdi>Deploy to GitHub pages</h3><a class="self-link" href="#deploy-to-github-pages" aria-label="Permalink for Section 2.3"></a></div>
<p>Deployment is only done on <code>push</code> events. In this example:</p>
<ul>
<li>the document is built and validated as a check in the pull request.</li>
<li>the document is built and validated, and then deployed to <code>gh-pages</code> branch, when a commit is pushed to the <code>main</code> branch.</li>
</ul>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Create a file called .github/workflows/auto-publish.yml
name: CI
on:
  pull_request: {}
  push:
    branches: [main]
jobs:
  main:
    name: Build, Validate and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          GH_PAGES_BRANCH: gh-pages
</code></pre>
<section id="change-output-location-for-built-files"><div class="header-wrapper"><h4 id="x2-3-1-change-output-location-for-built-files"><bdi class="secno">2.3.1 </bdi>Change output location for built files</h4><a class="self-link" href="#change-output-location-for-built-files" aria-label="Permalink for Section 2.3.1"></a></div>
<p>By default, output location is mapped to the <code>SOURCE</code>. You can change that by providing a <a href="#destination"><code>DESTINATION</code></a>.</p>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Create a file called .github/workflows/auto-publish.yml
name: CI
on:
  push:
    branches: [main]
jobs:
  main:
    name: Deploy to GitHub pages
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          GH_PAGES_BRANCH: gh-pages
          TOOLCHAIN: bikeshed
          SOURCE: src/spec.bs
          DESTINATION: specification/index.html # `src/spec.html` if not provided.
          # Deployment will be available at: https://&lt;org&gt;.github.io/&lt;repo&gt;/specification/
</code></pre>
</section></section><section id="deploy-to-w3c-using-echidna"><div class="header-wrapper"><h3 id="x2-4-deploy-to-w3c-using-echidna"><bdi class="secno">2.4 </bdi>Deploy to W3C using Echidna</h3><a class="self-link" href="#deploy-to-w3c-using-echidna" aria-label="Permalink for Section 2.4"></a></div>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Create a file called .github/workflows/auto-publish.yml
name: CI
on:
  pull_request: {}
  push:
    branches: [main]
jobs:
  main:
    name: Build, Validate and Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          W3C_ECHIDNA_TOKEN: ${{ secrets.ECHIDNA_TOKEN }}
          # Replace following with appropriate value. See options.md for details.
          W3C_WG_DECISION_URL: https://lists.w3.org/Archives/Public/public-group/2014JulSep/1234.html
</code></pre>
<section id="use-different-respecconfig-when-deploying-to-w3c"><div class="header-wrapper"><h4 id="x2-4-1-use-different-respecconfig-when-deploying-to-w3c"><bdi class="secno">2.4.1 </bdi>Use different <code>respecConfig</code> when deploying to W3C</h4><a class="self-link" href="#use-different-respecconfig-when-deploying-to-w3c" aria-label="Permalink for Section 2.4.1"></a></div>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Example: Override respecConfig for W3C deployment and validators.
name: CI
on:
  pull_request: {}
  push:
    branches: [main]
jobs:
  main:
    name: Build, Validate and Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          TOOLCHAIN: respec
          W3C_ECHIDNA_TOKEN: ${{ secrets.ECHIDNA_TOKEN }}
          W3C_WG_DECISION_URL: https://WG_DECISION_URL_FOR_MY_SPEC.com
          # Publish to w3.org/TR as a Working Draft (WD) under a different shortName.
          W3C_BUILD_OVERRIDE: |
            specStatus: WD
            shortName: my-custom-shortname
</code></pre>
<p>See <a href="#w3c_build_override"><code>W3C_BUILD_OVERRIDE</code></a> and <a href="#gh_pages_build_override"><code>GH_PAGES_BUILD_OVERRIDE</code></a> for details.</p>
</section></section><section id="multiple-specs-in-same-repository"><div class="header-wrapper"><h3 id="x2-5-multiple-specs-in-same-repository"><bdi class="secno">2.5 </bdi>Multiple specs in same repository</h3><a class="self-link" href="#multiple-specs-in-same-repository" aria-label="Permalink for Section 2.5"></a></div>
<p>If you maintain multiple documents in the same repository, you can provide source-destination pairs to build, validate and deploy each one separately.</p>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Create a file called .github/workflows/auto-publish.yml
name: CI
on:
  pull_request: {}
  push:
    branches: [main]
jobs:
  main:
    name: Build, Validate and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      max-parallel: 1
      matrix:
        include:
          - source: spec.html
            destination: index.html
            echidna_token: ECHIDNA_TOKEN_SPEC
          - source: spec-1
            destination: the-spec
            echidna_token: ECHIDNA_TOKEN_SPEC1
          - source: spec-2
            # destination defaults to spec-2/index.html
            # echidna_token defaults to no publication to w3.org/TR
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          SOURCE: ${{ matrix.source }}
          DESTINATION: ${{ matrix.destination }}
          GH_PAGES_BRANCH: gh-pages
          W3C_ECHIDNA_TOKEN: ${{ secrets[matrix.echidna_token] }}
          W3C_WG_DECISION_URL: "https://lists.w3.org/Archives/Public/xyz.html"
</code></pre>
<p><strong>Note:</strong> Echidna tokens need to be specified per document but secrets cannot be directly evaluated at the <code>matrix</code> level, meaning that <code>${{ secrets.ECHIDNA_TOKEN_SPEC }}</code> cannot be evaluated at that level. As in the above example, the idea is rather to name the token secret at the <code>matrix</code> level (through <code>echidna_token: ECHIDNA_TOKEN_SPEC</code>) and to evaluate the secret in the job's <code>steps</code> (through <code>${{ secrets[matrix.echidna_token] }}</code>).</p>
<p><strong>Note:</strong> Add the <code>max-parallel: 1</code> setting as in the example if you run into situations where jobs attempt to push updates to the repository at the same time and fail (see <a href="https://github.com/w3c/spec-prod/issues/58">#58</a>). This setting makes GitHub run jobs sequentially.</p>
<p><strong>Note:</strong> At present, each source might create its own commit in <code>GH_PAGES_BRANCH</code> even when content of other sources hasn't changed. This is because the build output for each source contains build date. Though, if you deploy multiple times in the same day, the noise will reduce effectively as the build date (hence the diff) hasn't changed. The situation will improve when <a href="https://github.com/w3c/spec-prod/issues/8">#8</a> and <a href="https://github.com/w3c/spec-prod/issues/14">#14</a> are fixed.</p>
<p>As a <em title="a cumbersome one!">workaround</em>, you can create separate workflows for each document and use GitHub Actions' <a href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#onpushpull_requestpaths"><code>on.&lt;push|pull_request&gt;.paths</code></a> as:</p>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Create a file called .github/workflows/auto-publish-spec-1.yml
name: CI (spec-1)
on:
  pull_request:
    paths: ["spec-1/**"]
  push:
    branches: [main]
    paths: ["spec-1/**"]

jobs:
  main:
    name: Build, Validate and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          SOURCE: spec-1
          DESTINATION: the-spec
          GH_PAGES_BRANCH: gh-pages
          W3C_ECHIDNA_TOKEN: ${{ secrets.ECHIDNA_TOKEN }}
          W3C_WG_DECISION_URL: "https://lists.w3.org/Archives/Public/xyz.html"

# Create another file called .github/workflows/auto-publish-spec-2.yml
name: CI (spec-2)
on:
  pull_request:
    paths: ["spec-2/**"]
  push:
    branches: [main]
    paths: ["spec-2/**"]

jobs:
  main:
    name: Build, Validate and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: w3c/spec-prod@v2
        with:
          SOURCE: spec-2/spec.bs
          DESTINATION: spec-2/index.html
          GH_PAGES_BRANCH: gh-pages
          W3C_ECHIDNA_TOKEN: ${{ secrets.ECHIDNA_TOKEN }}
          W3C_WG_DECISION_URL: "https://lists.w3.org/Archives/Public/xyz.html"
</code></pre>
</section></section>
		<section id="options"><div class="header-wrapper"><h2 id="x3-options"><bdi class="secno">3. </bdi>Options</h2><a class="self-link" href="#options" aria-label="Permalink for Section 3."></a></div>
<section id="toolchain"><div class="header-wrapper"><h3 id="x3-1-toolchain"><bdi class="secno">3.1 </bdi><code>TOOLCHAIN</code></h3><a class="self-link" href="#toolchain" aria-label="Permalink for Section 3.1"></a></div>
<p>Toolchain to use.</p>
<p><strong>Possible values:</strong> <code>respec</code>, <code>bikeshed</code>.</p>
<p><strong>Default:</strong> None. Inferred from <code>SOURCE</code>: <code>respec</code> if an <code>index.html</code> exists, or <code>bikeshed</code> if an <code>index.bs</code> exists.</p>
</section><section id="source"><div class="header-wrapper"><h3 id="x3-2-source"><bdi class="secno">3.2 </bdi><code>SOURCE</code></h3><a class="self-link" href="#source" aria-label="Permalink for Section 3.2"></a></div>
<p>Source file path.</p>
<p><strong>Possible values:</strong> Any valid POSIX file path relative to repository root.</p>
<p><strong>Default:</strong> None. Inferred from <code>TOOLCHAIN</code>: <code>index.html</code>/<code>index.bs</code> if exists.</p>
</section><section id="destination"><div class="header-wrapper"><h3 id="x3-3-destination"><bdi class="secno">3.3 </bdi><code>DESTINATION</code></h3><a class="self-link" href="#destination" aria-label="Permalink for Section 3.3"></a></div>
<p>Location of generated HTML document and other assets. This is useful when you've multiple specs in same repository.</p>
<p><strong>Possible values:</strong> Any valid POSIX file path relative to repository root.</p>
<p><strong>Default:</strong> <code>SOURCE</code>, with file extension set to <code>.html</code>.</p>
<table class="def">
<thead>
<tr>
<th><code>SOURCE</code></th>
<th><code>DESTINATION</code></th>
<th>Location of generated spec</th>
<th>Assets copied to directory</th>
</tr>
</thead>
<tbody><tr>
<td><code>index.bs</code></td>
<td>None</td>
<td><code>./index.html</code></td>
<td><code>./</code></td>
</tr>
<tr>
<td><code>my-spec/</code></td>
<td>None</td>
<td><code>./my-spec/index.html</code></td>
<td><code>./my-spec/</code></td>
</tr>
<tr>
<td><code>path/to/spec.bs</code></td>
<td>None</td>
<td><code>./path/to/spec.html</code></td>
<td><code>./path/to/</code></td>
</tr>
<tr>
<td><code>my-spec-src</code></td>
<td><code>my-spec-out</code></td>
<td><code>./my-spec-out/index.html</code></td>
<td><code>./my-spec-out/</code></td>
</tr>
<tr>
<td><code>index.html</code></td>
<td><code>index.html</code></td>
<td><code>./index.html</code></td>
<td><code>./</code></td>
</tr>
</tbody></table>
</section><section id="build_fail_on"><div class="header-wrapper"><h3 id="x3-4-build_fail_on"><bdi class="secno">3.4 </bdi><code>BUILD_FAIL_ON</code></h3><a class="self-link" href="#build_fail_on" aria-label="Permalink for Section 3.4"></a></div>
<p>Define exit behaviour on build errors or warnings.</p>
<p><strong>Possible values:</strong> <code>"nothing"</code>, <code>"fatal"</code>, <code>"link-error"</code>, <code>"warning"</code>, <code>"everything"</code>.</p>
<table class="def">
<thead>
<tr>
<th><code>BUILD_FAIL_ON</code></th>
<th>Bikeshed</th>
<th>ReSpec</th>
</tr>
</thead>
<tbody><tr>
<td>nothing</td>
<td><code>--die-on=nothing</code></td>
<td>Absent.</td>
</tr>
<tr>
<td>fatal</td>
<td><code>--die-on=fatal </code></td>
<td><code>--haltonerror</code> (<code>-e</code>)</td>
</tr>
<tr>
<td>link-error</td>
<td><code>--die-on=link-error</code></td>
<td><code>--haltonerror</code> (<code>-e</code>)</td>
</tr>
<tr>
<td>warning</td>
<td><code>--die-on=warning </code></td>
<td><code>--haltonwarn</code> (<code>-w</code>)</td>
</tr>
<tr>
<td>everything</td>
<td><code>--die-on=everything </code></td>
<td><code>-e -w</code></td>
</tr>
</tbody></table>
<p><strong>Default:</strong> <code>"fatal"</code>.</p>
</section><section id="gh_pages_build_override"><div class="header-wrapper"><h3 id="x3-5-gh_pages_build_override"><bdi class="secno">3.5 </bdi><code>GH_PAGES_BUILD_OVERRIDE</code></h3><a class="self-link" href="#gh_pages_build_override" aria-label="Permalink for Section 3.5"></a></div>
<p>Override Bikeshed metadata or ReSpec config for the GitHub Pages deployment.</p>
<p>Note that, you need to use <a href="https://tabatkins.github.io/bikeshed/">Bikeshed-specific metadata</a> (e.g. <code>status</code>) when using Bikeshed, and <a href="https://respec.org/docs/#configuration-options">ReSpec-specific config</a> (e.g. <code>specStatus</code>) when using ReSpec.</p>
<p><strong>Possible values:</strong> A string or <a href="https://stackoverflow.com/a/15365296">YAML Literal Block Scalar</a> (multiline string) representing the override config/metadata as key-value pairs. That's mouthful, lets clarify using an example:</p>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Example: Override Bikeshed metadata for GitHub Pages deployment
- uses: w3c/spec-prod@v2
  with:
    TOOLCHAIN: bikeshed
    GH_PAGES_BUILD_OVERRIDE: |
      status: w3c/WD
      TR: https://www.w3.org/TR/my-cool-spec/
    # Warning: The content in GH_PAGES_BUILD_OVERRIDE might look like YAML key-value pairs, but it's actually a string.
    # GitHub Actions allow only strings as input.
    #
    # Info: Above is same as running Bikeshed CLI like:
    # bikeshed spec INPUT OUTPUT --md-status="w3c/WD" --md-TR="https://www.w3.org/TR/my-cool-spec/"
</code></pre>
<p><strong>Default:</strong> None.</p>
</section><section id="w3c_build_override"><div class="header-wrapper"><h3 id="x3-6-w3c_build_override"><bdi class="secno">3.6 </bdi><code>W3C_BUILD_OVERRIDE</code></h3><a class="self-link" href="#w3c_build_override" aria-label="Permalink for Section 3.6"></a></div>
<p>Override Bikeshed metadata or ReSpec config for the W3C Deployment and validators.</p>
<p>The Action will try to make use of metadata/config from previously published version, if available. For example, you do not need to manually provide <code>respecConfig.previousPublishDate</code> (or, <code>Previous Version</code> in case of Bikeshed) when publishing to W3C.</p>
<p><strong>Possible values:</strong> Same as <a href="#gh_pages_build_override"><code>GH_PAGES_BUILD_OVERRIDE</code></a>.</p>
<p><strong>Default:</strong> None.</p>
<pre class="example"><code class="yaml hljs" aria-busy="false"># Example: Override respecConfig for W3C deployment and validators.
- uses: w3c/spec-prod@v2
  with:
    TOOLCHAIN: respec
    W3C_BUILD_OVERRIDE: |
      specStatus: WD
      shortName: my-custom-shortname
    # Warning: The content in W3C_BUILD_OVERRIDE might look like YAML key-value pairs, but it's actually a string.
    # GitHub Actions allow only strings as input.
    #
    # Info: Above is equivalent to running ReSpec CLI like:
    # respec -s index.html?specStatus=WD&amp;shortName=my-custom-shortnameโฆ -o OUTPUT
</code></pre>
</section><section id="validate_input_markup"><div class="header-wrapper"><h3 id="x3-7-validate_input_markup"><bdi class="secno">3.7 </bdi><code>VALIDATE_INPUT_MARKUP</code></h3><a class="self-link" href="#validate_input_markup" aria-label="Permalink for Section 3.7"></a></div>
<p>Whether or not to validate the markup of the input document using the <a href="https://github.com/validator/validator">Nu Html Checker</a>. This option is unlikely to be useful for Bikeshed documents, or for ReSpec documents based on markdown.</p>
<p><strong>Possible values:</strong> true, false</p>
<p><strong>Default:</strong> false</p>
</section><section id="validate_webidl"><div class="header-wrapper"><h3 id="x3-8-validate_webidl"><bdi class="secno">3.8 </bdi><code>VALIDATE_WEBIDL</code></h3><a class="self-link" href="#validate_webidl" aria-label="Permalink for Section 3.8"></a></div>
<p>Whether or not to validate the Web IDL that the spec may define.</p>
<p>Spec authoring tools may already include some level of Web IDL validation but that validation may be restricted to detecting syntax errors. The action also checks additional constraints defined in <a href="https://heycam.github.io/webidl/">Web IDL</a> such as usage of dictionaries as function parameters or attributes. The action will automatically skip validation if the spec does not define any Web IDL.</p>
<p>Note that the Web IDL validation is restricted to the spec at hand and cannot validate that references to IDL constructs defined in other specs are valid. As such, there may remain IDL errors that can only be detected by tools that look at all specs in combination such as <a href="https://github.com/w3c/webref">Webref</a>).</p>
<p><strong>Possible values:</strong> true, false</p>
<p><strong>Default:</strong> true</p>
</section><section id="validate_links"><div class="header-wrapper"><h3 id="x3-9-validate_links"><bdi class="secno">3.9 </bdi><code>VALIDATE_LINKS</code></h3><a class="self-link" href="#validate_links" aria-label="Permalink for Section 3.9"></a></div>
<p>Whether or not to check for broken hyperlinks.</p>
<p><strong>Warning:</strong> This feature is experimental.</p>
<p><strong>Possible values:</strong> true, false</p>
<p><strong>Default:</strong> false</p>
</section><section id="validate_markup"><div class="header-wrapper"><h3 id="x3-10-validate_markup"><bdi class="secno">3.10 </bdi><code>VALIDATE_MARKUP</code></h3><a class="self-link" href="#validate_markup" aria-label="Permalink for Section 3.10"></a></div>
<p>Whether or not to validate markup of the generated document using the <a href="https://github.com/validator/validator">Nu Html Checker</a>.</p>
<p><strong>Possible values:</strong> true, false</p>
<p><strong>Default:</strong> true</p>
</section><section id="gh_pages_branch"><div class="header-wrapper"><h3 id="x3-11-gh_pages_branch"><bdi class="secno">3.11 </bdi><code>GH_PAGES_BRANCH</code></h3><a class="self-link" href="#gh_pages_branch" aria-label="Permalink for Section 3.11"></a></div>
<p>Whether or not to deploy to GitHub pages. Set to a Falsy value to not deploy, or provide a Git branch name to push to. You would need to enable GitHub pages publish source in repository settings manually.
When this option is set, you need to ensure that the <code>GITHUB_TOKEN</code> for the job running spec-prod has <a href="https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token"><code>write</code> access to the <code>contents</code> scope</a>.</p>
<p><strong>Possible values:</strong>: None, or a git branch name.</p>
<p><strong>Default:</strong> None</p>
</section><section id="gh_pages_token"><div class="header-wrapper"><h3 id="x3-12-gh_pages_token"><bdi class="secno">3.12 </bdi><code>GH_PAGES_TOKEN</code></h3><a class="self-link" href="#gh_pages_token" aria-label="Permalink for Section 3.12"></a></div>
<p>GitHub Personal access token. This field is required only if the default GitHub actions token doesn't have enough permissions, or you want to have more control. Make sure to <a href="https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets">pass it as a secret</a>.</p>
<p><strong>Possible values:</strong>: A valid personal GitHub token.</p>
<p><strong>Default:</strong> <a href="https://docs.github.com/en/actions/configuring-and-managing-workflows/authenticating-with-the-github_token"><code>GITHUB_TOKEN</code></a></p>
</section><section id="w3c_echidna_token"><div class="header-wrapper"><h3 id="x3-13-w3c_echidna_token"><bdi class="secno">3.13 </bdi><code>W3C_ECHIDNA_TOKEN</code></h3><a class="self-link" href="#w3c_echidna_token" aria-label="Permalink for Section 3.13"></a></div>
<p>The automated publication workflow requires a <a href="https://github.com/w3c/echidna/wiki/Token-creation">token</a> associated with the specification you want to publish. Working Group Chairs and W3C Team members can <a href="https://www.w3.org/Web/publications/register">request a token</a> directly from the W3C. This can then be saved as <code>ECHIDNA_TOKEN</code> in your repository settings under <a href="downloaded-assets/user-images.githubusercontent.com/870154/81380287-f9579f80-914d-11ea-84bc-5707bff75dba.png">"Secrets"</a>.</p>
<p><strong>Possible values:</strong> A valid Echidna token.</p>
<p><strong>Default:</strong> None.</p>
</section><section id="w3c_wg_decision_url"><div class="header-wrapper"><h3 id="x3-14-w3c_wg_decision_url"><bdi class="secno">3.14 </bdi><code>W3C_WG_DECISION_URL</code></h3><a class="self-link" href="#w3c_wg_decision_url" aria-label="Permalink for Section 3.14"></a></div>
<p>A URL to the working group decision to use auto-publish, usually from a w3c mailing list.</p>
<p><strong>Possible values:</strong> A non-exhaustive list of possible values:</p>
<ul>
<li>WebApps WG: <a href="https://lists.w3.org/Archives/Public/public-webapps/2014JulSep/0627.html">https://lists.w3.org/Archives/Public/public-webapps/2014JulSep/0627.html</a></li>
<li>Media Capture WG: <a href="https://lists.w3.org/Archives/Public/public-media-capture/2015Dec/0031.html">https://lists.w3.org/Archives/Public/public-media-capture/2015Dec/0031.html</a></li>
<li>Second Screen WG: <a href="https://lists.w3.org/Archives/Public/public-secondscreen/2015Jun/0096.html">https://lists.w3.org/Archives/Public/public-secondscreen/2015Jun/0096.html</a></li>
<li>Web RTC: <a href="https://lists.w3.org/Archives/Public/public-webrtc/2016Mar/0031.html">https://lists.w3.org/Archives/Public/public-webrtc/2016Mar/0031.html</a></li>
<li>Aria: <a href="https://lists.w3.org/Archives/Public/public-html-admin/2015May/0021.html">https://lists.w3.org/Archives/Public/public-html-admin/2015May/0021.html</a></li>
<li>Device APIs: <a href="https://lists.w3.org/Archives/Public/public-device-apis/2021May/0008.html">https://lists.w3.org/Archives/Public/public-device-apis/2021May/0008.html</a></li>
<li>Web Performance: <a href="https://lists.w3.org/Archives/Public/public-web-perf/2021Apr/0005.html">https://lists.w3.org/Archives/Public/public-web-perf/2021Apr/0005.html</a></li>
<li>WebAppSec: <a href="https://lists.w3.org/Archives/Public/public-webappsec/2015Mar/0170.html">https://lists.w3.org/Archives/Public/public-webappsec/2015Mar/0170.html</a></li>
<li>Web Payments WG: <a href="https://www.w3.org/2016/04/14-wpwg-minutes.html#item02">https://www.w3.org/2016/04/14-wpwg-minutes.html#item02</a></li>
</ul>
<p><strong>Default:</strong> None.</p>
</section><section id="w3c_notifications_cc"><div class="header-wrapper"><h3 id="x3-15-w3c_notifications_cc"><bdi class="secno">3.15 </bdi><code>W3C_NOTIFICATIONS_CC</code></h3><a class="self-link" href="#w3c_notifications_cc" aria-label="Permalink for Section 3.15"></a></div>
<p>Comma separated list of email addresses to CC. This field is optional.</p>
<p><strong>Default:</strong> None.</p>
</section><section id="artifact_name"><div class="header-wrapper"><h3 id="x3-16-artifact_name"><bdi class="secno">3.16 </bdi><code>ARTIFACT_NAME</code></h3><a class="self-link" href="#artifact_name" aria-label="Permalink for Section 3.16"></a></div>
<p>Name for artifact which will be uploaded to workflow run. Required to be unique when building multiple documents in same job.</p>
<p><strong>Possible values:</strong> Any valid artifact name.</p>
<p><strong>Default:</strong> <code>"spec-prod-result"</code> or inferred from <code>SOURCE</code>.</p>
</section></section>
		<section id="other-useful-resources"><div class="header-wrapper"><h2 id="x4-other-useful-resources"><bdi class="secno">4. </bdi>Other useful resources</h2><a class="self-link" href="#other-useful-resources" aria-label="Permalink for Section 4."></a></div>
<ul>
<li>Denis Ah-Kang (W3C) gave an overview of the automatic publishing system on the 18 March 2021:
<a href="https://www.w3.org/2021/03/18-echidna/video.html">video with transcript</a>
and <a href="https://www.w3.org/2021/03/18-pub-minutes.html">minutes</a> are available.</li>
</ul>
</section>
	

<p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">โ</abbr></a>
  </p><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script></body></html>